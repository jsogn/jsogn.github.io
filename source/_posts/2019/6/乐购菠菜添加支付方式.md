---
layout: post
title: 乐购菠菜添加支付方式
tags:
  - php
categories:
  - php
password: Legou
abbrlink: 25578
date: 2019-05-31 20:42:56
---

### 前言

突然有一天老板扔给我一个错误百出的文档（文档不规范，码农两行泪），让我往某不知名网站添加某不可描述支付

<!--more-->

### 分析

- 登录后台发现有添加第三方支付的菜单，但是发现只能更改配置，无法添加新的支付方式（知道不会这么简单）

- 进入数据库发现数据存储在`payment_config`表中，试着直接数据库添加查看数据变化，添加后发现只能出现在支付列表中，无法添加和更改配置

- 查看页面请求，直接阅读获取支付代码，发现有一个`pay.json`的配置文件，直接打开，部分代码如下

```json
[
    {
        "nid": "nid_pay",
        "name": "请选择类型",
        "merchantID": "支付平台提供给商家的账号",
        "terminalID": "支付平台提供给商家的终端号",
        "merchantKey": "支付平台提供个商家的密码（MD5加密时使用）",
        "merchantPayKey": "支付有关的其他秘钥或信息",
        "partnerId": "支付平台代理商账号",
        "merchantPrivateKey": "用户私钥（与用户公钥成对存在）",
        "merchantPublicKey": "用户公钥（与用户私钥成对存在）",
        "platformPublicKey": "平台公钥（平台提供，一般在商户登录支付平台后台管理页面获取）",
        "merchantCertPath": "商家证书",
        "platformCertPath": "平台证书",
        "payBank": [{"bank_id":1,"code":"ICBC"},{"bank_id":2,"code":"ABC"},{"bank_id":9,"code":"BOC"},{"bank_id":7,"code":"CCB"},
        			{"bank_id":10,"code":"COMM"},{"bank_id":11,"code":"CMB"},{"bank_id":14,"code":"SPDB"},{"bank_id":26,"code":"CIB"},
        			{"bank_id":15,"code":"CMBC"},{"bank_id":13,"code":"GDB"},{"bank_id":12,"code":"SPDB"},{"bank_id":8,"code":"CEB"},
        			{"bank_id":29,"code":"HXB"},{"bank_id":3,"code":"PSBC"},{"bank_id":6,"code":"PAB"}
    			],
        "pay_layers": "1,2,3,5,4,6,7,8,9,10,11",
        "payType": [
	        {"id": 1,"name":"微信扫码支付","payStr":"支付配置信息","typeStr":"其他支付配置信息","payEntrance":"端口类型：1=ios,2=android,3=h5,4=pc","payStatus":"是否启用：1:启用;2:禁用","request_type":"返回数据or跳转页面：1：返回数据，2:跳转页面"},
	        {"id": 2,"name":"微信WAP支付","payStr":"WX_WAP","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":2},
	        {"id": 3,"name":"微信H5支付","payStr":"WX_H5","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":2},
	        {"id": 4,"name":"支付宝扫码支付","payStr":"ALI","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":1},
	        {"id": 5,"name":"支付宝WAP支付","payStr":"ALI_WAP","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":2},
	        {"id": 6,"name":"支付宝H5支付","payStr":"ALI_H5","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":2},
	        {"id": 7,"name":"QQ钱包扫码支付","payStr":"QQ","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":1},
	        {"id": 8,"name":"QQ钱包WAP支付","payStr":"QQ_WAP","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":2},
	        {"id": 9,"name":"QQ钱包H5支付","payStr":"QQ_H5","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":2},
	        {"id": 10,"name":"网银支付","payStr":"WY","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":2},
	        {"id": 11,"name":"网银H5支付","payStr":"WY_H5","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":2},
	        {"id": 12,"name":"网银快捷支付","payStr":"WY_KJ","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":2},
        	{"id": 13,"name":"京东钱包扫码支付","payStr":"JD","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":1},
	        {"id": 14,"name":"京东钱包WAP支付","payStr":"JD_WAP","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":2},
	        {"id": 15,"name":"京东钱包H5支付","payStr":"JD_H5","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":2},
	        {"id": 16,"name":"银联钱包扫码支付","payStr":"UN","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":1},
	        {"id": 17,"name":"银联钱包WAP支付","payStr":"UN_WAP","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":2},
	        {"id": 18,"name":"银联钱包H5支付","payStr":"UN_H5","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":2},
          {"id": 19,"name":"网关支付扫码","payStr":"gateway","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":2},
          {"id": 20,"name":"微信公众账号","payStr":"weixinjsapi","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":1},
          {"id": 21,"name":"支付宝服务窗支付","payStr":"weixinjsapi","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":1},
          {"id": 22,"name":"支付宝app支付","payStr":"alipayapp","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":1},
          {"id": 23,"name":"苏宁扫码支付","payStr":"suning","typeStr":"","payEntrance":"1,2,3,4","payStatus":1,"request_type":1}
	        ],
        "sort": 0
    },
    {
        "nid": "hua_yin_pay",
        "name": "华银",
        "merchantID": "",
        "merchantPrivateKey": "",
        "merchantPublicKey": "",
        "platformPublicKey": "",
        "payType": [
        	{"id": 1,"name":"微信扫码支付","payStr":"weixin_scan","payEntrance":"1,2,3,4","payStatus":1,"request_type":1},
        	{"id": 4,"name":"支付宝扫码支付","payStr":"alipay_scan","payEntrance":"1,2,3,4","payStatus":1,"request_type":1},
        	{"id": 7,"name":"QQ钱包宝扫码支付","payStr":"tenpay_scan","payEntrance":"1,2,3,4","payStatus":1,"request_type":1},
        	{"id": 10,"name":"网银支付","payStr":"direct_pay","payEntrance":"1,2,3,4","payStatus":1,"request_type":2}
        ]
    },
]
```

思路已经清晰了，直接从文件中添加了一个新的支付配置，果然后台支付列表中出现了，添加上该支付的配置参数

- 添加后，发起支付，报无此支付方式的错误，直接在代码中搜索这个错误信息，找到这个`PayFactory.php`工厂类，部分代码如下

```php
<?php

/**
 * Created by Kevin.
 * @author kevin
 * @copyright HCHT 2017/9/15 17:06
 * @description 支付工厂类
 */

include_cache(S_CORE . 'class' . DS . 'pay'  . DS . 'chengyi.php');

class PayFactory
{
	public function getInterface($payMent)
	{
        switch ($payMent) {
            case 'cheng_yi_pay':
                return new cheng_yi_pay();
                break;
            default:
                ErrorCode::errorResponse(200015, '线上支付方式不存在');
        }
	}
}
```

思路已经很明朗了，创建一个支付类，添加上case分支

- 随便打开一个支付类，根据它的部分逻辑，接入新的支付逻辑，处理异步回调时，发现有两个回调可供选择，一个在`recharge.php`中，一个在根目录下的`rechargeNotify.php`中，同步回调在根目录下`beeePayOk.php`，具体可阅读代码，没有必要张贴

### 实现
具体的支付类代码，仅供参考，每个支付的具体实现都有差别

```php


<?php

/**
 * @description 诚意支付
 */

include_cache(S_CORE . 'class' . DS . 'pay' . DS . 'payinfo' . '.php');

class ChengYiPay extends PayInfo
{
    //请求接口Url
    public $url      = 'https://pay.chenyipay.com/api/pay/v2';
    //接口名称
    public $payName  = '诚意支付';

    //获取支付返回数据格式
    public $retArr = [               //支付信息返回格式
            'code' => 1,             //0:数据获取成功，其他数字，数据获取失败
            'msg' => '',             //返回的提示信息
            'data' => []             //返回数据
        ];

    //回调处理返回数据格式
    public $orderInfo = [            //异步验签结果返回格式
        'code' => 0,                 //0：数据获取成功，其他数字，数据获取失败
        'bank_num' => 219050,        //银行区分号（不同支付的前三位不同）
        'order_no' => '',            //后台数据库支付订单号
        'amount' => 0,               //支付金额
        'ret_error' => 0,            //回调处理失败时，返回接口字符串
        'ret_success' => 'ok',        //回调处理成功时，返回接口字符串
        'bank_name' => '诚意支付',     //支付方式名称
        'serial_no' => ''            //第三方回调返回的第三方支付订单号（支付流水号）
    ];

    /**
     * 构成函数
     */
    public function __construct()
    {
        parent::__construct();
    }

    /**
     * 调用第三方支付接口，获取支付信息
     * @param array $data 前端返回信息，payment_id，支付类型ID，config，支付类型配置信息
     * {@inheritDoc}
     * @see PayInfo::doPay()
     * @return $this->$retArr;
     */
    public function doPay($data)
    {
        //生成订单
        $orderInfo = $this->makeOrder($data);
        if (!$orderInfo) {
            $this->retArr['code'] = 219000;
            $this->retArr['msg']  = '支付订单生成失败';
            payLog('payerror.log', '（' . $this->retArr['code'] . '）' . $this->payName . '订单生成失败，' . print_r($data, true));

            return $this->retArr;
        }

        //获取配置支付信息
        $config      = unserialize($data['config']);
        $callbackurl = $config['callbackurl']?$config['callbackurl']:$_SERVER['HTTP_HOST'];

        if (empty($data['pay_type']) || empty($config['payType'][$data['pay_type']])) {
            $this->retArr['code'] = 219001;
            $this->retArr['msg']  = '支付银行类型不存在';
            payLog('payerror.log', '（' . $this->retArr['code'] . '）' . $this->payName . '银行类型不存在，' . print_r($data, true));

            return $this->retArr;
        }

        $postData = [
            'p1_mchtid'   => $config['merchantID'],
            'p2_paytype'  => $config['payType'][$data['pay_type']]['payStr'],
            'p3_paymoney' => $data['money'],
            'p4_orderno'  => $orderInfo,
            //异步
            'p5_callbackurl' => "http://".$callbackurl."/?m=api&c=recharge&a=rechargeNotify&payment_id=" . $data['payment_id'],
            //同步
            'p6_notifyurl' => "http://".$callbackurl."/beeePayOk.php",
            'p7_version'   => 'v2.9',
            'p8_signtype'  => '2',
            'p9_attach'    => 'chengyi_' . $data['payment_id'],
            'p10_appname'  => '',
            'p11_isshow'   => '0',
            'p12_orderip'  => ip(),
            'p13_memberid' => $data['user_id'],
        ];

        payLog('chengyi.txt',print_r($postData,true));

        //待签名字符串
        $signStr   = $this->get_sign($postData);
        //生成签名
        $postData["sign"] = md5($signStr.$config['merchantKey']);
        //转为json字符串
        $jsonStr   = json_encode($postData);
        //获取公钥
        $publicKey = $this->publicKeyStr($config['merchantPublicKey']);
        //公钥加密
        $reqdata   = urlencode($this->publicEncrypt($publicKey, $jsonStr));
        //请求参数
        $signData["mchtid"]  = $config['merchantID'];
        $signData["reqdata"] = $reqdata;

        //判断支付网关是否是wap
        if ($config['payType'][$data['pay_type']]['request_type'] == 2) {
            $retData =  [
                'type'  => $config['payType'][$data['pay_type']]['request_type'],
                'modes' => $data['pay_model'],
                'html'  => $this->paramToHtmlForm($this->url, $signData)
            ];

            $this->retArr['code'] = 0;
            $this->retArr['data']  = $retData;

            return $this->retArr;
        }

        //发起请求
        $result = $this->httpRequest($this->url, json_encode($signData));
        //将json字符串转为数组
        $resultArr = json_decode($result,true);
        //判断返回信息
        if ($resultArr['rspCode'] != 1 && !$resultArr['data']) {
            $this->retArr['code'] = 219002;
            $this->retArr['msg']  = '支付二维码生成失败！';
            payLog('payerror.log', '（' . $this->retArr['code'] . '）' . $this->payName . $resultArr["rspMsg"] . print_r($resultArr, true));

            return $this->retArr;
        }

        $resultData = $resultArr['data'];
        //验签
        $re = $this->payVerify($resultData, $config['merchantKey']);

        if (!$re) {
            $this->retArr['code'] = 219003;
            $this->retArr['msg']  = '支付二维码生成失败！';

            payLog('payerror.log', '（' . $this->retArr['code'] . '）' . $this->payName . '验签失败' . print_r($resultArr, true));

            return $this->retArr;
        }

        payLog('chengyi.txt',print_r($resultData, true). "===134");


        $retOderNo           = $orderInfo;
        $retOderPayNo        = isset($resultData['r2_systemorderno']) ? $resultData['r2_systemorderno'] : 'chengyipay' . date('YmdHis');
        $retOderPayQrcodrUrl = isset($resultData['r6_qrcode']) ? $resultData['r6_qrcode'] : '';

        $result = D('accountRecharge')->getOneCoupon('id', array('order_sn' => $retOderNo, 'status' => 0));

        if (empty($result)) {
            $this->retArr['code'] = 219004;
            $this->retArr['msg']  = '支付二维码生成失败！';
            payLog('payerror.log', '（' . $this->retArr['code'] . '）' . $this->payName . '返回数据成功,但订单表没有查到相应未完成的订单号，' . print_r($resultArr, true));

            return $this->retArr;
        }

        D('accountRecharge')->save(['remark' => $retOderPayNo], ['order_sn' => $retOderNo]);

        // 用于安全验证返回url是否非法
        $shortQrcodrUrl =$this->shortUrl($retOderPayQrcodrUrl, '5cf1028991d2c405942b1569@f15436319999938d84e5f8b7d25e9dda');
        if (!$shortQrcodrUrl) {
            $this->retArr['code'] = 219005;
            $this->retArr['msg']  = '支付二维码生成失败！';
            payLog('payerror.log', '（' . $this->retArr['code'] . '）' . $this->payName . '二维码获取成功，但转换短链接失败' . print_r($resultArr, true));

            return $this->retArr;
        }

        session::set('qrcode_url', $shortQrcodrUrl);
        session::set('pay_url', '');

        //type =1 返回二维码数据
        $ret =  [
            'type'     => $config['payType'][$data['pay_type']]['request_type'],
            'code_url' => $shortQrcodrUrl,
            'pay_url'  => '',
            'order_no' => $orderInfo,
            'modes'    => $data['pay_model']
        ];

        $this->retArr['code'] = 0;
        $this->retArr['data'] = $ret;

        return $this->retArr;
    }

    /**
     * 支付回调处理
     * @param array $postData data：回调返回的数据，payment_Id：支付类型ID
     * {@inheritDoc}
     * @see PayInfo::doPaycallBack()
     * @return array $this->$retArr;
     */
    public function doPaycallBack($postData)
    {
        //接收回调后 返回 ok;
        echo 'ok';

        //处理post回调数据
        $data       = json_decode($postData['data'], true);
        $reqdata    = $data['reqdata'];
        $config     = unserialize($postData['config']);

        payLog('chengyi.txt',print_r($postData, true).'----996--');

        //判断字符串是否需要 urldecode解
        if (strpos($reqdata, '%')) {
            $reqdata =  urldecode($reqdata);
        }

        if (!is_array($config)) {
            $this->orderInfo['code'] = 219020;
            payLog('payerror.log', '（' . $this->orderInfo['code'] . '）支付异步通知,获取数据库配置错误！'  . print_r($data, true));

            return $this->orderInfo;
        }

        if (!$reqdata) {
            $this->orderInfo['code'] = 219021;
            payLog('payerror.log', '（' . $this->orderInfo['code'] . '）支付异步通知:获取重要参数错误！'  . print_r($data, true));

            return $this->orderInfo;
        }

        //获取私钥
        $private_key = $this->privateKeyStr($config['merchantPrivateKey']);
        //解密
        $dataJson    = $this->privateDecrypt($reqdata, $private_key);

        if (!$dataJson) {
            $this->orderInfo['code'] = 219022;
            payLog('payerror.log', '（' . $this->orderInfo['code'] . '）支付异步通知：支付解密失败！'  . print_r($data, true));

            return $this->orderInfo;
        }

        $arr = json_decode($dataJson, true);
        $arr['partner'] = $config['merchantID'];

        //去除不需要参入验签的字段
        unset($arr["sysnumber"]);
        unset($arr["attach"]);

        //验证签名
        $re = $this->payVerify($arr, $config['merchantKey']);

        if (!$re) {
            $this->orderInfo['code'] = 219023;
            payLog('payerror.log', '（' . $this->orderInfo['code'] . '）支付异步通知：验签失败！'  . print_r($arr, true));

            return $this->orderInfo;
        }

        if (!isset($arr['orderstatus']) || $arr['orderstatus'] != 1 ) {
            $this->orderInfo['code'] = 219024;
            payLog('payerror.log', '（' . $this->orderInfo['code'] . '）支付异步通知：支付失败！'  . print_r($data, true));

            return $this->orderInfo;
        }

        $this->orderInfo['code']  = 0;
        $this->orderInfo['order_no']  = $data['ordernumber'];
        $this->orderInfo['amount']    = $data['paymoney'];
        $this->orderInfo['serial_no'] = $data['sysnumber'];

        return $this->orderInfo;
    }


    /**
     * [get_sign 拼接签名字符串]
     * @param  [type] $arr 数组
     * @return [type]      [description]
     */
    public  function get_sign($arr)
    {
		$signmd5="";
		foreach($arr as $x=>$x_value)
		{
			if($signmd5==""){
				$signmd5 =$signmd5.$x .'='. $x_value;
			}else{
				$signmd5 = $signmd5.'&'.$x .'='. $x_value;
			}

		}
		return $signmd5;
    }

    /**
     * [publicKeyStr 公钥字符串处理]
     * @param  [type] $publicStr 公钥字符串
     * @return [type]            [description]
     */
    public   function publicKeyStr($publicStr)
    {
        $public_key = "-----BEGIN PUBLIC KEY-----\r\n";
        foreach (str_split($publicStr,64) as $str){
            $public_key .= $str . "\r\n";
        }
        $public_key .="-----END PUBLIC KEY-----";

        return $public_key;
    }

    /**
      * [publicEncrypt 公钥加密]
      * @param  [type] $publicKey 公钥
      * @param  [type] $data      加密字符串
      * @return [type]            [description]
      */
      public  function publicEncrypt($publicKey, $data)
      {
        $key = openssl_get_publickey($publicKey);

        $original_arr = str_split($data,117);
        foreach($original_arr as $o) {
            $sub_enc = null;
            openssl_public_encrypt($o,$sub_enc,$key);
            $original_enc_arr[] = $sub_enc;
        }

        openssl_free_key($key);
        $original_enc_str = base64_encode(implode('',$original_enc_arr));

        return $original_enc_str;
    }

    /**
     * [paramToHtmlForm form表单方法]
     * @param  [type] $url    请求URL
     * @param  [type] $params 数组 请求参数
     * @return [type]         [description]
     */
    public  function paramToHtmlForm($url,$params)
    {
        $def_url = "<form id='form' name='payForm' action='".$url."' method='POST'>\r";
        foreach ($params as $key => $value) {
            $def_url .="<input type='hidden' name='".$key."' value='".$value."'>\r";
        }
        $def_url .="<input type='submit' value='确认提交'></form><script language='javascript'>window.onload=function(){document.payForm.submit();}</script>";

        return $def_url;
    }

    /**
     * [httpRequest http请求]
     * @param  [type] $url  请求URL
     * @param  [type] $data 请求参数 json字符串
     * @return [type]       [description]
     */
    public  function httpRequest($url,$data)
    {
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE);
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE);
        curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (compatible; MSIE 5.01; Windows NT 5.0)');
        curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/json','Content-Length: ' . strlen($data)));
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
        curl_setopt($ch, CURLOPT_AUTOREFERER, 1);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        $tmpInfo = curl_exec($ch);
        if (curl_errno($ch)) {
            return curl_error($ch);
        }

        return $tmpInfo;
    }

    /**
     *[payVerify 支付付验签]
     * @param  [type] $result [返回的参数]
     * @return [type] $md5    [MD5]
     */

    public function payVerify($result,$md5)
    {
        $signStr = $result['sign'];
        $sign_array = array();
        foreach ($result as $k => $v) {
            if ($k !== 'sign'){
                $sign_array[$k] = $v;
            }
        }
        $sign  = md5($this->get_sign($sign_array).$md5);
        if($signStr != $sign){
            return false;
        }

        return true;
    }

    function CurlQuery($url)
    {
        //设置附加HTTP头
        $addHead = array(
            "Content-type: application/json"
        );
        $curl_obj = curl_init();
        curl_setopt($curl_obj, CURLOPT_URL, $url);
        curl_setopt($curl_obj, CURLOPT_HTTPHEADER, $addHead);
        curl_setopt($curl_obj, CURLOPT_HEADER, 0);
        curl_setopt($curl_obj, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($curl_obj, CURLOPT_TIMEOUT, 15);
        $result = curl_exec($curl_obj);
        curl_close($curl_obj);

        return $result;
  }

    //根据长网址获取短网址
    function shortUrl($long_url, $appkey)
    {
        $long_url = urlencode($long_url);
        $url = 'http://mrw.so/api.php?format=json&url=' . $long_url . '&key=' . $appkey . '&expireDate=' . date("Y-m-d",strtotime("+3 day"));

        //获取请求结果
        $result = $this->CurlQuery($url);
        $json = json_decode($result);
        //异常情况返回false
        if ($json->err) {
            return false;
        }

        return $json->url;
    }

     /**
     * 提交表单数据
     * @param array $post_data 表单提交数据
     * @param string $url 表单提交接口
     * @return string
     */
    function httpHtml($post_data, $url)
    {
        $html = '<html>';
        $html = '<head>';
        $html .= '<meta http-equiv="Content-Type" content="text/html; charset=gb2312">';
        $html .= '</head>';
        $html .= '<body onLoad="document.dinpayForm.submit();">';
        $html .= '<form id="payFrom" name="dinpayForm" method="get" action="' . $url . '">';
        foreach ($post_data as $key => $value) {
            $html .= '<input type="hidden" name="' . $key . '" value="' . $value . '"/>';
        }
        $html .= '</form>';
        $html .= '</body>';
        $html .= '</html>';
        return $html;
    }

     /**
     * 调用第三方接口，提交数据
     * @param string $url 第三方接口url
     * @param array $postdata 提交数据
     * @return array[]|mixed[] 返回数据
     */
    public function httpPost($data, $url, $path='')
    {
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_POST, 1);
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, true);
        curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
        curl_setopt($ch, CURLOPT_CAINFO, $path);
        curl_setopt($ch, CURLOPT_HEADER, 0);
        curl_setopt($ch, CURLOPT_HTTPHEADER,array('Content-Type: application/json; charset=utf-8','Content-Length:' . strlen($data)));
        curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 2);

        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        return array('code' => $httpCode, 'data' => $response);
    }

    /**
     * [privateKeyStr 私钥钥字符串处理]
     * @param  [type] $privatekey [description]
     * @return [type]             [description]
     */
    public function privateKeyStr($privatekey)
    {
        $private_key = "-----BEGIN PRIVATE KEY-----\r\n";
        foreach (str_split($privatekey,64) as $str){
            $private_key .= $str . "\r\n";
        }
        $private_key .="-----END PRIVATE KEY-----";

        return $private_key;
    }

    /**
     * [decode 私钥解密]
     * @param  [type] $data       [待解密字符串]
     * @param  [type] $privateKey [私钥]
     * @return [type]             [description]
     */
    public function privateDecrypt($data,$privateKey)
    {
        //读取秘钥
        $pr_key = openssl_pkey_get_private($privateKey);
        if ($pr_key == false){
            echo "打开密钥出错";
            die;
        }
        $data = base64_decode($data);
        $crypto = '';
        //分段解密
        foreach (str_split($data, 128) as $chunk) {
            openssl_private_decrypt($chunk, $decryptData, $pr_key);
            $crypto .= $decryptData;
        }

        return $crypto;
    }

}
```

- rechargeNotify回调核心代码

```php

<?php
/**
 * desc: 处理线上支付无参数路由支付回调处理方法：通过url调用执行该文件，获取相关支付确认信息后，通过curl转发到带参数路由的api接口
 */
define('S_ROOT', dirname(__FILE__) . DIRECTORY_SEPARATOR);
//require S_ROOT . 'core' . DIRECTORY_SEPARATOR . 'base.php';

$data       = [];  //支付回调数据
$payData    = '';  //支付回传的支付参数，规定：使用"_"将支付名称与支付ID连接起来，如兄弟支付：'xiongdi_123'
$payType    = '';  //支付类型
$payment_id = '';  //支付方式ID

//不同的支付方式获取数据的方式可能不同，根据不同的支付，添加不同的获取回调数据的方法，如：$_GET\$_POST\$_REQUEST\（php://input）
$postData = file_get_contents("php://input");  //获取post参数字符串类型数据
payLog('callbackRecharge.txt',print_r($postData,true).'---23---');

//数据处理，不同的支付方式，可能数据处理方式不同
if  (!empty($postData)) {
    if (!simplexml_load_string($postData, 'SimpleXMLElement', LIBXML_NOCDATA)) {
       parse_str($postData, $data);
    } else {
        $data = json_decode(json_encode(simplexml_load_string($postData, 'SimpleXMLElement', LIBXML_NOCDATA)), true);
    }
    payLog('callbackRecharge.txt',print_r($postData,true).'---20---' . print_r(simplexml_load_string($postData, 'SimpleXMLElement', LIBXML_NOCDATA),true));
} else {
    $data = $_REQUEST;
}

payLog('callbackRecharge.txt',print_r($data,true).'---26---');

if (!empty($data)) {
    payLog('callbackRecharge.txt', '异步充值接参数通知数据：' . print_r($data, true));  //日志，记录转接数据

    if (isset($data['pay_attach'])) {
        $payData = explode('_', $data['pay_attach']);
    }

    if (empty($payData)) {
        exit('0');
    }

    $payType    = $payData[0] ?? '';
    $payment_id = $payData[1] ?? '';
}


if (!empty($data) && !empty($payment_id)) {

    payLog('curlRecharge.log', '异步充值url转接参数通知数据：' . print_r($data, true));  //日志，记录转接数据

    $ret = httpPostApi($data, $payment_id);   //异步充值通知转接
    payLog('callbackRecharge.txt',print_r($ret,true).'----73--');

    echo $ret;  //输出结果数据
}


/**
 * 充值异步转接接口调用，post数据转发，表单提交数据库格式
 * @param array $payData  需要转发的数据
 * @param int $paymentId  线上支付方式ID
 * @return mixed|number   返回数据
 */
function httpPostApi($payData, $paymentId)
{
    //路由api接口
    $payUrl = "https://".$_SERVER['HTTP_HOST']."/?m=api&c=recharge&a=rechargeNotify&payment_id=" . $paymentId;

    $ch = curl_init();
    curl_setopt($ch,CURLOPT_URL, $payUrl);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_HEADER, false);
    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($payData));
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

    $response=curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);

    curl_close($ch);
    if ($httpCode == 200) {
        return $response;
    } else {
        return 0;
    }
}

/**
 * 支付日志
 * @param  string $fileName 文件名,如：payerror.log或者pay/error.log
 * @param  array $data 数据
 */
function payLog($fileName, $data)
{
    $pathLog = S_ROOT . 'caches' . DIRECTORY_SEPARATOR . 'log' . DIRECTORY_SEPARATOR . $fileName;
    if (is_file($pathLog)) {
        if (filesize($pathLog) >= 10000000) {
            $new_file = dirname($pathLog) . '/' . date('Y_m_d_H_i_s').'_'  . basename($pathLog);
            copy($pathLog,$new_file);
            file_put_contents($pathLog, '<----' . date('Y-m-d H:i:s').'---->' . $data . "\n");
        }else {
            file_put_contents($pathLog, '<----' . date('Y-m-d H:i:s').'---->' . $data . "\n", FILE_APPEND);
        }
    }else {
        file_put_contents($pathLog, '<----' . date('Y-m-d H:i:s').'---->' . $data . "\n", FILE_APPEND);
    }
}
```